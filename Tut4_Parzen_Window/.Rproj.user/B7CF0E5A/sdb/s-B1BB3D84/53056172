{
    "collab_server" : "",
    "contents" : "\n############################################################################################################################\n#####THIS SCRIPT EXTRACTS DATA FROM THE PUBLIC API OF UN COMTRADE. \n###YOU CAN SKIP TO 02-EXTRACT DATA\n##AUTHOR: SIMON WEISS, MA PHILOSPHY & ECONOMICS, 5TH SEMESTER, UNIVERSITY OF BAYREUTH\n############################################################################################################################\n\n#####Restrictions\n#THE MAXIMUM NUMBER OF RECORDS PER REQUEST IS 50000. IF THE QUEREY EXCEEDS MAX RESULTS THE DATA GETS TRUNCATED\n#PARAMETER COMBINATIONS FOR TIME PERIODS, REPORTING COUNTRIES, PARTNER COUNTRIES ARE LIMITED TO 5 CODES EACH AND ONLY ONE CAN USE \"ALL\"\n#CLASSIFICATION CODES ARE LIMITED TO 20\n#1 REQUEST PER SECOND, 100 REQUESTS PER HOUR\n\n\n#####00-PRELIMINARIES\n#SET WORKING DIRECTORY\nsetwd(\"C:/Users/weiss/OneDrive/01_Uni Bayreuth/01_Masterarbeit/01_Project/rawdata\")\n\n\nlibrary(rjson)\nstring <- \"http://comtrade.un.org/data/cache/partnerAreas.json\"\nreporters <-fromJSON(file=string)\nreporters <- as.data.frame(t(sapply(reporters$results, rbind)))\n\n\n#####01-DEFINING FUNCTION TO EXTRACT DATA (SEE http://comtrade.un.org/data/Doc/api/ex/r)\nget.Comtrade <- function(url=\"http://comtrade.un.org/api/get?\"\n                         ,maxrec=50000\n                         ,type=\"C\"\n                         ,freq=\"A\"\n                         ,px=\"HS\"\n                         ,ps=\"now\"\n                         ,r\n                         ,p\n                         ,rg=\"all\"\n                         ,cc=\"TOTAL\"\n                         ,fmt=\"json\"\n)\n{\n  string<- paste(url\n                 ,\"max=\",maxrec,\"&\" #maximum no. of records returned\n                 ,\"type=\",type,\"&\" #type of trade (c=commodities)\n                 ,\"freq=\",freq,\"&\" #frequency\n                 ,\"px=\",px,\"&\" #classification\n                 ,\"ps=\",ps,\"&\" #time period\n                 ,\"r=\",r,\"&\" #reporting area\n                 ,\"p=\",p,\"&\" #partner country\n                 ,\"rg=\",rg,\"&\" #trade flow\n                 ,\"cc=\",cc,\"&\" #classification code\n                 ,\"fmt=\",fmt        #Format\n                 ,sep = \"\"\n  )\n  \n  if(fmt == \"csv\") {\n    raw.data<- read.csv(string,header=TRUE)\n    return(list(validation=NULL, data=raw.data))\n  } else {\n    if(fmt == \"json\" ) {\n      raw.data<- fromJSON(file=string)\n      data<- raw.data$dataset\n      validation<- unlist(raw.data$validation, recursive=TRUE)\n      ndata<- NULL\n      if(length(data)> 0) {\n        var.names<- names(data[[1]])\n        data<- as.data.frame(t( sapply(data,rbind)))\n        ndata<- NULL\n        for(i in 1:ncol(data)){\n          data[sapply(data[,i],is.null),i]<- NA\n          ndata<- cbind(ndata, unlist(data[,i]))\n        }\n        ndata<- as.data.frame(ndata)\n        colnames(ndata)<- var.names\n      }\n      return(list(validation=validation,data =ndata))\n    }\n  }\n}\n\n\n############################################################################################################################\n#####02-Extract data\n############################################################################################################################\n#type= PARAMETER TYPE c(commoditites), s(services) |default=c\n#freq= PARAMETER FREQUENCY A(annual), M(monthly) |default=A\n#px= CLASSIFICATION e.g. HS for \"HS as reported\" FOR MORE SEE http://comtrade.un.org/data/doc/api/ |default=HS\n#ps= TIME PERIOD YYYY or YYYYMM or now or recent |default=now\n#r= REPORTING COUNTRY e.g. 842 for USA, SEE \"reporters\" DATAFRAME |default=0\n#p= PARTNER COUNTRY e.g. 0 for world, SEE \"reporters\" DATAFRAME |default=all\n#rg= TRADE FLOW e.g. 1 (imports) or 2 (exports) SEE http://comtrade.un.org/data/cache/tradeRegimes.json/ |default=all\n#cc= CLASSIFICATION CODE e.g. AG1, AG2... |default AG2\n#head= HEADING STYLE H(human readable), M(Machine readable) |default=H\n#fmt= OUTPUT FORMAT json or csv\n##FOR MORE SEE http://comtrade.un.org/data/doc/api/\n\n\n#####02B- VIA A LOOP\n#IF NECESSARY SPLIT REPORTERS LIST TO NOT EXCEED THE 100 REQUEST/HOUR RESTRICTION.\nls_reporterstop25 <- c(792, 203, 410, 710, 616, 56, 484, 392, 699, 36, 458,\n                       724, 40, 251, 579, 246, 124, 528, 752, 381, 826, 276, 702, 156, 842)\n  \n\n\n#DOWNLOAD DATA INTO DATA FRAMES AND STORE THEM IN 2 NEW LISTS (TO NOT EXCEED MAX OF 20 ELEMENTS FOR \"cc\")\n#PAUSING FOR 1 SECOND INBETWEEN ITERATIONS TO NOT EXCEED 1 REQUEST PER SECOND RESTRICTION:\ncomtrade_data1 <- lapply(ls_reporterstop25, function(i) {\n  Sys.sleep(1)\n  tmp1 <- get.Comtrade(r=i, p=\"0\", freq=\"M\", ps=\"all\", cc=\"723410,728310,728320,744230,841239,841350,841360,842520,842531,\n                      842539,842831,842850,842890,842951\", rg=\"2\", fmt=\"csv\")\n  df1 <- as.data.frame(do.call(rbind, tmp1))\n  return(df1)\n  })\n#NAME EACH ELEMENT(DATA FRAME) ACCORDING TO THE COUNTRY NUMBER\ncomtrade_data1 <- setNames(comtrade_data1, paste0(\"df_q\", ls_reporterstop25,\"a\"))\n\n#SEE EXPLANATION ABOVE\ncomtrade_data2 <- lapply(ls_reporterstop25, function(i) {\n  Sys.sleep(1)\n  tmp2 <- get.Comtrade(r=i, p=\"0\", freq=\"M\", ps=\"all\", cc=\"843031,843039,843041,843049,843050,843062,843139,843143,843149,\n                      847410,847420,847490,847989,870520\", rg=\"2\", fmt=\"csv\")\n  df2 <- as.data.frame(do.call(rbind, tmp2))\n  return(df2)\n})\n#NAMING THE LIST ELEMENTS\ncomtrade_data2 <- setNames(comtrade_data2, paste0(\"df_q\", ls_reporterstop25,\"b\"))\n\n#COMBINE THE DATA FRAMES FROM EACH LIST INTO A SINGLE DATA FRAME \ndf_data1 <- do.call(\"rbind\", comtrade_data1)\ndf_data2 <- do.call(\"rbind\", comtrade_data2)\n#COMBINE THE TWO DATA FRAMES INTO ONE DATA FRAME\ndf_top25 <- do.call(\"rbind\", list(df_data1, df_data2))\n\n\n\n\n############################################################################################################################\n#####03-Export Data\n############################################################################################################################\n\n#csv FILE\nwrite.table(df_top25, file=\"uncomtrade_top25.csv\", sep = \",\", row.names=F)\n\n#dta FILE\nlibrary(foreign)\nwrite.dta(df_top25, \"uncomtrade_top25.dta\", convert.factors = \"string\")\n",
    "created" : 1480323002975.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2281872853",
    "id" : "53056172",
    "lastKnownWriteTime" : 1480080821,
    "last_content_update" : 1480080821,
    "path" : "C:/Users/weiss/OneDrive/01_Uni Bayreuth/01_Masterarbeit/01_Project/regression/specific_un_comtrade_data_extract.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}